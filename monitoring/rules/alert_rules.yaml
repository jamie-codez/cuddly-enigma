groups:
  - name: HostAlerts
    rules:
      - alert: HostDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ $labels.instance }} down"
          description: "{{ $labels.instance }} has been down for more than 1 minute."

      - alert: HighCpuUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100) > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 85% for more than 5 minutes. Current value is {{ $value }}%."

      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Less than 10% disk space remaining. Current value is {{ $value }}%."

  - name: ContainerAlerts
    rules:
      - alert: ContainerKilled
        expr: time() - container_last_seen > 60
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Container {{ $labels.name }} has disappeared"
          description: "Container {{ $labels.name }} is no longer visible."

      - alert: ContainerCpuUsageHigh
        expr: (sum(rate(container_cpu_usage_seconds_total{name="devops-app"}[3m])) by (name)) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage for container {{ $labels.name }}"
          description: "{{ $labels.name }} CPU usage is above 80% for 5 minutes."

  - name: ApplicationAlerts
    rules:
      - alert: HighErrorRate
        # SLO: 99.9% success rate. Alert if we burn 2% of our monthly error budget in 1h.
        expr: (sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (job) / sum(rate(http_requests_total[5m])) by (job)) * 100 > 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate on {{ $labels.job }}"
          description: "More than 1% of requests are failing with 5xx errors. Current error rate is {{ $value }}%."

      - alert: HighRequestLatency
        # SLO: 95% of requests < 300ms. Alert if the 95th percentile is over 300ms.
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job)) > 0.3
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on {{ $labels.job }}"
          description: "The 95th percentile of request latency is over 300ms. Current latency is {{ $value }}s."